<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ottobrunner Hofflohmarkt 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Add Nostr tools library (specific version) -->
    <script>
        // Create a global object to hold the Nostr tools
        window.nostrTools = {};
    </script>
    <!-- Use a CDN that provides a specific version known to work -->
    <script src="https://unpkg.com/nostr-tools@1.8.0/lib/nostr.bundle.js"></script>
    <!-- Add a direct script for WebSocket polyfill if needed -->
    <script>
        // Ensure WebSocket is available
        if (typeof WebSocket === 'undefined') {
            console.error("WebSocket is not defined in this environment");
        } else {
            console.log("WebSocket is available");
        }

        // Copy the library functions to our global object and make them available globally
        if (window.NostrTools) {
            console.log("NostrTools loaded successfully");

            // Make sure we have the essential functions
            if (!window.NostrTools.signEvent && window.NostrTools.signEvent) {
                window.NostrTools.finalizeEvent = window.NostrTools.signEvent;
            }

            // Copy all functions to our global object
            for (const key in window.NostrTools) {
                window.nostrTools[key] = window.NostrTools[key];
            }

            // Log available functions for debugging
            console.log("Available NostrTools functions:", Object.keys(window.NostrTools));

            // Add direct global access to critical functions
            if (!window.getPublicKey && window.NostrTools.getPublicKey) {
                window.getPublicKey = window.NostrTools.getPublicKey;
            }

            if (!window.generatePrivateKey && window.NostrTools.generatePrivateKey) {
                window.generatePrivateKey = window.NostrTools.generatePrivateKey;
            }

            if (!window.finalizeEvent && window.NostrTools.finalizeEvent) {
                window.finalizeEvent = window.NostrTools.finalizeEvent;
            }

            if (!window.signEvent && window.NostrTools.signEvent) {
                window.signEvent = window.NostrTools.signEvent;
            }

            if (!window.relayInit && window.NostrTools.relayInit) {
                window.relayInit = window.NostrTools.relayInit;
            }
        } else {
            console.error("NostrTools not loaded correctly");
        }

        // Define a global function to check if the library is ready
        window.isNostrReady = function() {
            return (window.NostrTools &&
                   (typeof window.NostrTools.getPublicKey === 'function') &&
                   ((typeof window.NostrTools.finalizeEvent === 'function') ||
                    (typeof window.NostrTools.signEvent === 'function')));
        };
    </script>
    <!-- Nostr Chat Modules (Reihenfolge ist wichtig) -->
    <script>
        // Initialisiere globale Objekte
        window.NostrUtils = {};
        window.NostrCrypto = {};
        window.NostrProfile = {};
        window.NostrUI = {};
        window.NostrConnection = {};
        window.profileCache = {};
    </script>
    <!-- Chart.js f√ºr Diagramme -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="nostr-utils.js"></script>
    <script src="nostr-crypto.js"></script>
    <script src="nostr-profile.js"></script>
    <script src="nostr-ui.js"></script>
    <script src="nostr-connection.js"></script>
    <script src="nostr-chat.js"></script>
</head>
<body>
    <div class="container">
        <h1>Ottobrunner Hofflohmarkt 2025</h1>
        <h2>Samstag, 24. Mai 2025, 10:00 - 14:00 Uhr</h2>

        <div class="section">
            <p>Eine Benefizveranstaltung zugunsten des CRP-Bangladesch</p>
            <p><a href="https://www.crp-bangladesh.org" target="_blank" class="crp-link">www.crp-bangladesh.org</a></p>
        </div>

        <!--
        <div class="section highlight-section">
            <h3>Jetzt anmelden!</h3>
            <a href="registration.html" class="button register-button">
                ‚úÖ Als Verk√§ufer anmelden
            </a>
            <p>Melden Sie sich jetzt als Verk√§ufer f√ºr den Hofflohmarkt an</p>
        </div>
        -->

        <div class="section">
            <h3>F√ºr unterwegs:</h3>
            <a href="https://bit.ly/4j3T2Xh" class="button map-button" target="_blank">
                üó∫Ô∏è Interaktive Karte √∂ffnen
            </a>
            <p>Nutzen Sie die Google Maps-Ansicht auf Ihrem Smartphone</p>
        </div>

        <div class="section stats-section">
            <h3>Wachsender Erfolg seit 2013!</h3>
            <p class="lead-text">Der Ottobrunner Hofflohmarkt erfreut sich immer gr√∂√üerer Beliebtheit</p>
            <div class="stats-highlight">
                <span class="stats-number">69</span>
                <span class="stats-label">Garagen im Jahr 2024</span>
            </div>
            <p class="stats-description">
                Von 14 Garagen im Jahr 2018 auf beeindruckende 69 Teilnehmer in 2024 ‚Äì unser Hofflohmarkt w√§chst stetig!
                Seien Sie 2025 dabei und werden Sie Teil dieser Erfolgsgeschichte.
            </p>
            <div class="chart-container">
                <canvas id="participantsChart"></canvas>
            </div>
            <p class="stats-footnote">
                Seit 2019 verzeichnen wir einen kontinuierlichen Anstieg der Teilnehmerzahlen.
                Sichern Sie sich jetzt Ihren Platz f√ºr 2025!
            </p>
        </div>

        <div class="section">
            <h3>Impressionen vom letzten Jahr:</h3>
            <div class="carousel">
                <div class="carousel-container" id="carousel-container">
                    <!-- Images will be inserted here by JavaScript -->
                </div>
                <button class="carousel-button prev">‚ùÆ</button>
                <button class="carousel-button next">‚ùØ</button>
                <div class="carousel-dots" id="carousel-dots"></div>
            </div>
        </div>

        <div class="section">
            <h3>Nostr Chat</h3>
            <p>Chatten Sie mit anderen Besuchern und Verk√§ufern des Hofflohmarkts</p>

            <div id="nostr-login-container">
                <div class="chat-login-container">
                    <p>Um am Chat teilzunehmen, ben√∂tigen Sie einen Nostr-Schl√ºssel. Sie k√∂nnen einen neuen Schl√ºssel erstellen oder eine bestehende Nostr-Erweiterung verwenden.</p>
                    <button id="generate-key-button" class="chat-login-button">Neuen Schl√ºssel erstellen</button>
                    <button id="login-extension-button" class="chat-login-button">Mit Nostr-Erweiterung anmelden</button>
                </div>
            </div>

            <div id="nostr-chat-interface" style="display: none;">
                <div id="loading-indicator" class="loading-indicator">
                    <div class="spinner"></div>
                    <p>Verbindung wird hergestellt und Nachrichten werden geladen...</p>
                </div>

                <div id="chat-container" class="chat-container"></div>

                <div class="chat-input-container">
                    <input type="text" id="chat-input" class="chat-input" placeholder="Nachricht eingeben...">
                    <button id="chat-send-button" class="chat-send-button">Senden</button>
                </div>

                <p class="chat-info">
                    <small>Angemeldet als <span id="reset-identity-trigger">Sie</span>. Ihre Nachrichten werden mit Ihrem Nostr-Schl√ºssel signiert.</small>
                </p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Teilnehmerentwicklung Diagramm
            const ctx = document.getElementById('participantsChart').getContext('2d');

            // Daten f√ºr das Diagramm
            const years = ['2013', '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024'];
            const participants = [44, 22, 23, 19, 14, 14, 39, 34, 39, null, 65, 69];

            // Farben f√ºr das Diagramm
            const gradientFill = ctx.createLinearGradient(0, 0, 0, 300);
            gradientFill.addColorStop(0, 'rgba(26, 115, 232, 0.6)');
            gradientFill.addColorStop(1, 'rgba(26, 115, 232, 0.1)');

            // Diagramm erstellen
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Teilnehmende Garagen',
                        data: participants,
                        borderColor: '#1a73e8',
                        backgroundColor: gradientFill,
                        borderWidth: 3,
                        pointBackgroundColor: '#1a73e8',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    family: "'Open Sans', sans-serif",
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#333',
                            bodyColor: '#333',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    if (value === null) return 'Keine Daten verf√ºgbar';
                                    return `${value} ${value === 1 ? 'Garage' : 'Garagen'}`;
                                },
                                title: function(context) {
                                    return `Jahr ${context[0].label}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    family: "'Open Sans', sans-serif"
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Open Sans', sans-serif"
                                }
                            }
                        }
                    }
                }
            });

            // Karussell f√ºr Bilder
            const container = document.getElementById('carousel-container');
            const dotsContainer = document.getElementById('carousel-dots');
            let currentSlide = 0;

            // Bilder f√ºr das Karussell
            const images = [
                'photos/image1.png',
                'photos/image2.png',
                'photos/image3.jpg',
                'photos/image4.jpg',
                'photos/image5.jpg',
                'photos/image6.jpg'
            ];

            // Bilder und Punkte einf√ºgen
            images.forEach((image, index) => {
                // Slide erstellen
                const slide = document.createElement('div');
                slide.className = 'carousel-slide';

                // Bild erstellen
                const img = document.createElement('img');
                img.src = image;
                img.alt = `Flohmarkt Impression ${index + 1}`;

                // Zum Slide hinzuf√ºgen
                slide.appendChild(img);

                // Zum Container hinzuf√ºgen
                container.appendChild(slide);

                // Punkt erstellen
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (index === 0) dot.classList.add('active');

                // Event-Listener f√ºr den Punkt
                dot.addEventListener('click', () => {
                    goToSlide(index);
                });

                // Zum Dots-Container hinzuf√ºgen
                dotsContainer.appendChild(dot);
            });

            // Funktion zum Wechseln der Slides
            function goToSlide(n) {
                currentSlide = n;
                container.style.transform = `translateX(-${currentSlide * 100}%)`;

                // Aktiven Punkt aktualisieren
                document.querySelectorAll('.dot').forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentSlide);
                });
            }

            // Event-Listener f√ºr die Buttons
            document.querySelector('.carousel-button.prev').addEventListener('click', () => {
                currentSlide = (currentSlide - 1 + images.length) % images.length;
                goToSlide(currentSlide);
            });

            document.querySelector('.carousel-button.next').addEventListener('click', () => {
                currentSlide = (currentSlide + 1) % images.length;
                goToSlide(currentSlide);
            });

            // Automatischer Wechsel alle 5 Sekunden
            setInterval(() => {
                currentSlide = (currentSlide + 1) % images.length;
                goToSlide(currentSlide);
            }, 5000);
        });
    </script>
</body>
</html>
